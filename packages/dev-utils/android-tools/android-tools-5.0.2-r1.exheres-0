# Copyright 1999-2014 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# I(radaiming) copied the ebuild


SUMMARY="Android platform tools (adb and fastboot)"
HOMEPAGE="https://android.googlesource.com/platform/system/core.git/"
DOWNLOADS="
https://launchpad.net/ubuntu/+archive/primary/+files/android-tools_4.2.2%2Bgit20130218.orig.tar.xz
https://launchpad.net/ubuntu/+archive/primary/+files/android-tools_4.2.2%2Bgit20130218-3ubuntu38.debian.tar.xz"
# The entire source code is Apache-2.0, except for fastboot which is BSD.
LICENCES="Apache-2.0 BSD"
SLOT="0"
PLATFORMS="~amd64"
WORK="${WORKBASE}/android-tools/"

DEPENDENCIES="
    build+run:
        sys-libs/zlib
        dev-libs/openssl
"

DEFAULT_SRC_PREPARE_PATCHES=(
    ../debian/patches/add_adbd.patch
    ../debian/patches/add-bq-vendor-id.patch
    ../debian/patches/enable-emulator.patch
    ../debian/patches/ppc64el-ftbfs.patch
    ../debian/patches/reboot-syscall.patch
    ../debian/patches/remove-selinux-android.patch
)

src_prepare() {
    mv ../debian/makefiles/adb.mk core/adb/Makefile || die
    mv ../debian/makefiles/fastboot.mk core/fastboot/Makefile || die
	# Avoid libselinux dependency.
	edo sed -e 's: -lselinux::' -i core/fastboot/Makefile || die
	edo sed -e '/#include <selinux\/selinux.h>/d' \
		-e 's:#include <selinux/label.h>:struct selabel_handle;:' \
		-i extras/ext4_utils/make_ext4fs.h || die
	edo sed -e '62,64d;181,190d;232,235d;272,274d;565,580d' \
		-i extras/ext4_utils/make_ext4fs.c || die
}

src_compile() {
	pushd core/adb || die
	emake adb || die
	popd
	pushd core/fastboot || die
	emake fastboot || die
}

src_install() {
	dobin core/adb/adb
	dobin core/fastboot/fastboot
}
